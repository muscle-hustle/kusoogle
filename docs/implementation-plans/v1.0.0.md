# kusoogle v1.0.0 実装計画書

## 概要

本ドキュメントは、kusoogle v1.0.0（MVP）の実装計画を定義します。
各STEPごとに実装を行い、レビューとコミットを実施します。

## 実装範囲（v1.0.0）

### 含まれる機能
- ✅ 記事データ収集機能（Qiita APIから取得、Embedding化、Vectorize保存）
- ✅ 検索機能（ベクトル類似度検索）
- ✅ ユーザーインターフェース（検索フォーム、検索結果表示）

### 含まれない機能（Phase 2以降）
- ❌ 類似アプリ説明機能（LLMによる説明生成）

## 実装STEP一覧

### STEP 1: プロジェクトセットアップ
- モノレポ構成のセットアップ
- Bun workspacesの設定
- 基本的なディレクトリ構造の作成
- package.jsonの設定

### STEP 2: 共有パッケージの実装
- 型定義の実装
- ユーティリティ関数の実装
- 共有パッケージのビルド設定

### STEP 3: 設定ファイルの作成
- calendars.jsonの作成
- 設定ファイル読み込み機能の実装

### STEP 4: Data Collection Workerの実装
- Qiita API呼び出し機能
- 記事データのEmbedding化
- Vectorizeへの保存機能
- Cron Triggerの設定

### STEP 5: Search API Workerの実装
- 検索APIエンドポイントの実装
- クエリのEmbedding化
- Vectorize検索機能
- エラーハンドリング

### STEP 6: フロントエンド基盤の実装
- Next.jsプロジェクトのセットアップ
- レイアウトとスタイリング
- 基本的なページ構造

### STEP 7: フロントエンドコンポーネントの実装
- SearchFormコンポーネント
- SearchResultsコンポーネント
- ArticleCardコンポーネント
- SkeletonCardコンポーネント

### STEP 8: フロントエンド統合
- ページとコンポーネントの統合
- API連携
- エラーハンドリング
- ローディング状態の管理

### STEP 9: 初期データ取得
- 初期データ取得スクリプトの実装
- 過去年分のデータ取得とテスト

### STEP 10: デプロイ設定とテスト
- Cloudflare Workersのデプロイ設定
- Cloudflare Pagesのデプロイ設定
- 本番環境での動作確認

---

## STEP 1: プロジェクトセットアップ

### 目的
モノレポ構成をセットアップし、開発環境の基盤を整える。

### 実装内容
1. **ルートディレクトリの設定**
   - `package.json`の作成（Bun workspaces設定）
   - `.gitignore`の作成
   - `README.md`の更新（セットアップ手順）

2. **ディレクトリ構造の作成**
   ```
   kusoogle/
   ├── apps/
   │   ├── frontend/
   │   └── workers/
   │       ├── search/
   │       └── data-collection/
   ├── packages/
   │   └── shared/
   ├── config/
   ├── scripts/
   └── docs/
   ```

3. **各パッケージの基本設定**
   - `apps/frontend/package.json`
   - `apps/workers/search/package.json`
   - `apps/workers/data-collection/package.json`
   - `packages/shared/package.json`

4. **TypeScript設定**
   - ルートの`tsconfig.json`
   - 各パッケージの`tsconfig.json`

### 成果物
- [x] ルート`package.json`（Bun workspaces設定）
- [x] `.gitignore`
- [x] ディレクトリ構造
- [x] 各パッケージの`package.json`
- [x] TypeScript設定ファイル

### レビューポイント
- Bun workspacesの設定が正しいか
- ディレクトリ構造が仕様書通りか
- TypeScript設定が適切か

---

## STEP 2: 共有パッケージの実装

### 目的
フロントエンドとWorkersで共通して使用する型定義とユーティリティを実装する。

### 実装内容
1. **型定義の実装**
   - `packages/shared/src/types/article.ts`: Article型
   - `packages/shared/src/types/search.ts`: SearchResult型、SearchRequest型、SearchResponse型
   - `packages/shared/src/types/api.ts`: API関連の型

2. **ユーティリティ関数の実装**
   - `packages/shared/src/utils/date.ts`: 日付フォーマット関数
   - `packages/shared/src/utils/validation.ts`: バリデーション関数
   - `packages/shared/src/utils/text.ts`: テキスト処理関数

3. **パッケージのエクスポート**
   - `packages/shared/src/index.ts`: すべての型とユーティリティをエクスポート

4. **ビルド設定**
   - `packages/shared/package.json`のビルドスクリプト
   - TypeScriptのビルド設定

### 成果物
- [x] `packages/shared/src/types/article.ts`
- [x] `packages/shared/src/types/search.ts`
- [x] `packages/shared/src/types/api.ts`
- [x] `packages/shared/src/utils/date.ts`
- [x] `packages/shared/src/utils/validation.ts`
- [x] `packages/shared/src/utils/text.ts`
- [x] `packages/shared/src/index.ts`
- [x] ビルド設定

### レビューポイント
- 型定義が仕様書通りか
- ユーティリティ関数が適切に実装されているか
- エクスポートが正しいか

---

## STEP 3: 設定ファイルの作成

### 目的
Qiitaアドベントカレンダーの設定を管理するファイルと読み込み機能を実装する。

### 実装内容
1. **設定ファイルの作成**
   - `config/calendars.json`: カレンダーURLの設定
   - 2025年のカレンダーを設定（autoUpdate: true）
   - 過去年分のカレンダーを設定（autoUpdate: false）

2. **設定ファイルの型定義**
   - `packages/shared/src/types/config.ts`: CalendarConfig型

3. **設定読み込み機能**
   - `packages/shared/src/utils/config.ts`: 設定ファイル読み込み関数

### 成果物
- [x] `config/calendars.json`
- [x] `packages/shared/src/types/config.ts`
- [x] `packages/shared/src/utils/config.ts`

### レビューポイント
- 設定ファイルの形式が適切か
- カレンダーURLが正しいか
- 設定読み込み機能が正しく実装されているか

---

## STEP 4: Data Collection Workerの実装

### 目的
Qiita APIから記事を取得し、Embedding化してVectorizeに保存するWorkerを実装する。

### 実装内容
1. **プロジェクトセットアップ**
   - `apps/workers/data-collection/wrangler.toml`の作成
   - `apps/workers/data-collection/package.json`の設定

2. **Qiita API呼び出し機能**
   - `apps/workers/data-collection/src/utils/qiita.ts`: Qiita API呼び出し関数
   - レート制限の遵守
   - エラーハンドリングとリトライロジック

3. **記事処理機能**
   - `apps/workers/data-collection/src/utils/embedding.ts`: Embedding生成関数
   - `apps/workers/data-collection/src/utils/vectorize.ts`: Vectorize保存関数
   - 記事本文はEmbedding生成にのみ使用し、保存しない

4. **Cron Trigger実装**
   - `apps/workers/data-collection/src/index.ts`: Cron Triggerハンドラー
   - 最新年分のカレンダーのみ処理
   - 既存記事のチェック（重複回避）

5. **初期データ取得機能**
   - `scripts/initialize-data.ts`: 初期データ取得スクリプト
   - 過去年分のカレンダーを全件取得

### 成果物
- [x] `apps/workers/data-collection/wrangler.toml`
- [x] `apps/workers/data-collection/src/index.ts`
- [x] `apps/workers/data-collection/src/utils/qiita.ts`
- [x] `apps/workers/data-collection/src/utils/embedding.ts`
- [x] `apps/workers/data-collection/src/utils/vectorize.ts`
- [x] `scripts/initialize-data.ts`

### レビューポイント
- Qiita APIのレート制限を遵守しているか
- 記事本文を保存していないか（ベクトルのみ保存）
- エラーハンドリングが適切か
- Cron Triggerの設定が正しいか

---

## STEP 5: Search API Workerの実装

### 目的
検索クエリを受け取り、ベクトル類似度検索を実行して結果を返すAPI Workerを実装する。

### 実装内容
1. **プロジェクトセットアップ**
   - `apps/workers/search/wrangler.toml`の作成
   - `apps/workers/search/package.json`の設定

2. **Honoフレームワークのセットアップ**
   - `apps/workers/search/src/index.ts`: Honoアプリの初期化
   - CORS設定

3. **検索APIエンドポイント**
   - `apps/workers/search/src/handlers/search.ts`: 検索ハンドラー
   - クエリのバリデーション
   - クエリのEmbedding化
   - Vectorize検索（topK: 10）
   - 結果の整形

4. **エラーハンドリング**
   - バリデーションエラー
   - Vectorize検索エラー
   - AI Workers呼び出しエラー

### 成果物
- [x] `apps/workers/search/wrangler.toml`
- [x] `apps/workers/search/src/index.ts`
- [x] `apps/workers/search/src/handlers/search.ts`
- [x] エラーハンドリング

### レビューポイント
- APIエンドポイントが正しく実装されているか
- バリデーションが適切か
- エラーハンドリングが適切か
- CORS設定が正しいか

---

## STEP 6: フロントエンド基盤の実装

### 目的
Next.jsプロジェクトをセットアップし、基本的なページ構造とスタイリングを実装する。

### 実装内容
1. **Next.jsプロジェクトのセットアップ**
   - `apps/frontend/package.json`の設定
   - `apps/frontend/next.config.js`の作成
   - `apps/frontend/tsconfig.json`の設定

2. **レイアウトの実装**
   - `apps/frontend/app/layout.tsx`: ルートレイアウト
   - メタデータ設定
   - グローバルスタイル（Tailwind CSS）

3. **トップページの基本構造**
   - `apps/frontend/app/page.tsx`: トップページの基本構造
   - Headerの実装

4. **Tailwind CSSの設定**
   - `apps/frontend/tailwind.config.ts`の作成
   - カラーパレットの設定
   - カスタムスタイルの設定

### 成果物
- [x] `apps/frontend/package.json`
- [x] `apps/frontend/next.config.js`
- [x] `apps/frontend/app/layout.tsx`
- [x] `apps/frontend/app/page.tsx`
- [x] `apps/frontend/tailwind.config.ts`
- [x] `apps/frontend/postcss.config.js`
- [x] `apps/frontend/app/globals.css`

### レビューポイント
- Next.jsの設定が適切か
- レイアウトが仕様書通りか
- Tailwind CSSの設定が正しいか
- デザインシステムに沿っているか

---

## STEP 7: フロントエンドコンポーネントの実装

### 目的
検索フォーム、検索結果表示、記事カードなどのUIコンポーネントを実装する。

### 実装内容
1. **SearchFormコンポーネント**
   - `apps/frontend/components/SearchForm.tsx`
   - テキスト入力フィールド
   - 検索ボタン
   - バリデーション
   - エラーメッセージ表示

2. **SearchResultsコンポーネント**
   - `apps/frontend/components/SearchResults.tsx`
   - 検索結果の一覧表示
   - ローディング状態の表示
   - 結果がない場合のメッセージ

3. **ArticleCardコンポーネント**
   - `apps/frontend/components/ArticleCard.tsx`
   - 記事情報の表示（タイトル、URL、タグ、著者、投稿日時、いいね数）
   - 出典表示（「出典: Qiita」）
   - 「Qiitaで読む」リンク

4. **SkeletonCardコンポーネント**
   - `apps/frontend/components/SkeletonCard.tsx`
   - ローディング状態のプレースホルダー

### 成果物
- [x] `apps/frontend/components/SearchForm.tsx`
- [x] `apps/frontend/components/SearchResults.tsx`
- [x] `apps/frontend/components/ArticleCard.tsx`
- [x] `apps/frontend/components/SkeletonCard.tsx`

### レビューポイント
- コンポーネントが仕様書通りに実装されているか
- スタイリングがデザインシステムに沿っているか
- アクセシビリティが考慮されているか
- レスポンシブデザインが実装されているか

---

## STEP 8: フロントエンド統合

### 目的
コンポーネントを統合し、API連携と状態管理を実装する。

### 実装内容
1. **Server Actionの実装**
   - `apps/frontend/app/actions/search.ts`: 検索Server Action
   - Search API Workerへのリクエスト

2. **ページの統合**
   - `apps/frontend/app/page.tsx`: コンポーネントの統合
   - 状態管理（検索クエリ、結果、ローディング状態）
   - エラーハンドリング

3. **環境変数の設定**
   - `.env.local`の作成（開発環境用）
   - 環境変数の読み込み

4. **型定義の統合**
   - 共有パッケージの型定義を使用

### 成果物
- [ ] `apps/frontend/app/actions/search.ts`
- [ ] `apps/frontend/app/page.tsx`（統合版）
- [ ] `.env.local`（テンプレート）
- [ ] 環境変数の設定

### レビューポイント
- API連携が正しく実装されているか
- 状態管理が適切か
- エラーハンドリングが実装されているか
- ローディング状態が適切に表示されるか

---

## STEP 9: 初期データ取得

### 目的
過去年分のクソアプリアドベントカレンダーの記事を取得し、Vectorizeに保存する。

### 実装内容
1. **初期データ取得スクリプトの完成**
   - `scripts/initialize-data.ts`の完成
   - 過去年分のカレンダーを全件取得
   - レート制限の遵守

2. **データ取得の実行**
   - ローカル環境でのテスト実行
   - データの確認

3. **Vectorizeインデックスの確認**
   - インデックスの作成確認
   - データの保存確認

### 成果物
- [ ] `scripts/initialize-data.ts`（完成版）
- [ ] 初期データの取得完了
- [ ] Vectorizeインデックスの確認

### レビューポイント
- スクリプトが正しく動作するか
- レート制限を遵守しているか
- データが正しく保存されているか

---

## STEP 10: デプロイ設定とテスト

### 目的
Cloudflare WorkersとCloudflare Pagesのデプロイ設定を行い、本番環境で動作確認する。

### 実装内容
1. **Cloudflare Workersのデプロイ設定**
   - Search API Workerのデプロイ
   - Data Collection Workerのデプロイ
   - 環境変数の設定

2. **Cloudflare Pagesのデプロイ設定**
   - フロントエンドのデプロイ
   - 環境変数の設定

3. **Vectorizeインデックスの作成**
   - 本番環境でのインデックス作成

4. **動作確認**
   - 検索機能の動作確認
   - エラーハンドリングの確認
   - パフォーマンスの確認

### 成果物
- [ ] Cloudflare Workersのデプロイ完了
- [ ] Cloudflare Pagesのデプロイ完了
- [ ] Vectorizeインデックスの作成完了
- [ ] 動作確認完了

### レビューポイント
- デプロイが成功しているか
- 本番環境で正しく動作するか
- パフォーマンスが要件を満たしているか

---

## 実装順序の依存関係

```
STEP 1 (プロジェクトセットアップ)
  ↓
STEP 2 (共有パッケージ)
  ↓
STEP 3 (設定ファイル)
  ↓
STEP 4 (Data Collection Worker) ← STEP 2, 3に依存
  ↓
STEP 5 (Search API Worker) ← STEP 2に依存
  ↓
STEP 6 (フロントエンド基盤) ← STEP 2に依存
  ↓
STEP 7 (フロントエンドコンポーネント) ← STEP 6に依存
  ↓
STEP 8 (フロントエンド統合) ← STEP 5, 7に依存
  ↓
STEP 9 (初期データ取得) ← STEP 4に依存
  ↓
STEP 10 (デプロイ設定とテスト) ← すべてのSTEPに依存
```

## 各STEPの完了基準

各STEPは以下の条件を満たした時点で完了とします：

1. **実装完了**: 成果物がすべて作成されている
2. **動作確認**: ローカル環境で動作確認が完了している
3. **レビュー完了**: コードレビューが完了している
4. **コミット完了**: 変更がコミットされている

## 注意事項

- 各STEPごとにレビューとコミットを実施する
- 大きな変更は小さく分割して実装する
- エラーハンドリングは各STEPで適切に実装する
- Qiitaの利用規約を遵守する（記事本文は保存しない）
- レート制限を遵守する

