# ベクトル検索の仕組みと類似度スコアの解釈

## ベクトル検索とは

ベクトル検索は、テキストを数値ベクトル（Embedding）に変換し、ベクトル間の類似度を計算して検索する方法です。

### 処理フロー

1. **記事のEmbedding生成**: 記事のタイトル、タグ、本文を結合してEmbedding化
2. **検索クエリのEmbedding生成**: ユーザーが入力したクエリをEmbedding化
3. **類似度計算**: コサイン類似度でベクトル間の類似度を計算（0-1の範囲、1に近いほど類似）
4. **結果の並び替え**: 類似度の高い順に並び替え

## 類似度スコアの解釈

### コサイン類似度の範囲

- **1.0**: 完全に一致（同じベクトル）
- **0.8-0.9**: 非常に類似
- **0.6-0.8**: 類似
- **0.4-0.6**: やや類似
- **0.3-0.4**: 少し類似
- **0.0-0.3**: ほとんど関連がない

### データが少ない場合の問題

**データが1件しかない場合**:
- その1件が常に最上位の結果として返される
- 類似度スコア自体は実際の類似度を反映しているが、比較対象がないため、相対的な評価ができない
- 例: クエリ「タスク管理」と「完全に無関係なクエリ」の両方で同じ記事が返される可能性がある

**データが複数ある場合**:
- 複数の記事と比較できるため、より正確な類似度評価が可能
- 類似度の高い記事が上位に表示される

## 類似度の閾値

現在の実装では、**類似度スコアが0.3未満の記事は除外**しています。

### 閾値の意味

- **0.3未満**: ほとんど関連がないと判断し、検索結果から除外
- **0.3以上**: 検索結果に含める

### 閾値の調整

データが少ない場合や、より厳格な検索が必要な場合は、閾値を調整できます：

```typescript
// apps/workers/search/src/handlers/search.ts
const SIMILARITY_THRESHOLD = 0.3; // この値を調整
```

- **0.0**: すべての結果を表示（データが少ない場合に有効）
- **0.3**: デフォルト（推奨）
- **0.5**: より厳格な検索（類似度の高い記事のみ表示）

## 実際の類似度スコアの確認方法

### ログで確認

Search API Workerのログに、実際の類似度スコアが表示されます：

```
検索結果: 1件
  1. ID: e303cf655373992f61f4, 類似度: 0.8234, タイトル: 記事タイトル
類似度フィルタリング後: 1件 (閾値: 0.3)
```

### フロントエンドで確認

検索結果のカードに類似度スコアが表示されます（例: 「類似度: 82%」）。

## データが少ない場合の対処法

### 1. より多くのデータを追加

- 初期データ取得を完了させる
- 複数のカレンダーから記事を取得する

### 2. 閾値を調整

データが少ない場合は、閾値を下げる（例: 0.0）ことで、すべての結果を表示できます。

### 3. ログで確認

実際の類似度スコアをログで確認し、期待通りの値か確認します。

## よくある質問

### Q: 何を入力しても同じ記事が返ってくる

**A**: データが1件しかない場合、その1件が常に返されます。これは正常な動作です。より多くのデータを追加することで、より正確な検索が可能になります。

### Q: 類似度スコアが常に高い

**A**: データが少ない場合、比較対象がないため、類似度スコアが高く表示されることがあります。ログで実際のスコアを確認し、期待通りの値か確認してください。

### Q: 類似度スコアが低いのに結果に表示される

**A**: 現在の閾値（0.3）未満の結果は除外されています。より厳格な検索が必要な場合は、閾値を上げてください。

## まとめ

- **データが1件のみ**: その1件が常に返される（正常な動作）
- **類似度スコア**: 実際の類似度を反映しているが、比較対象がない場合は相対的な評価ができない
- **閾値フィルタリング**: 0.3未満の類似度の結果は除外
- **ログで確認**: 実際の類似度スコアをログで確認できる

より正確な検索を行うには、より多くのデータを追加することが重要です。

